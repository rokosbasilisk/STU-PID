<svg viewBox="0 0 1000 600" xmlns="http://www.w3.org/2000/svg">
  <!-- Define arrowhead marker -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
      <feOffset dx="2" dy="2" result="offsetblur"/>
      <feComponentTransfer>
        <feFuncA type="linear" slope="0.3"/>
      </feComponentTransfer>
      <feMerge> 
        <feMergeNode/>
        <feMergeNode in="SourceGraphic"/> 
      </feMerge>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1000" height="600" fill="#f8f9fa"/>
  
  <!-- Title -->
  <text x="500" y="38" font-family="Arial, sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#1a1a1a">
    STU-PID: Steering Tokens Using PID Control
  </text>

  <!-- Input prompt -->
  <rect x="20" y="200" width="80" height="60" rx="5" fill="#e0e0e0" stroke="#666" stroke-width="2"/>
  <text x="60" y="220" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#333">Math Problem</text>
  <text x="60" y="236" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#333">If Sara has</text>
  <text x="60" y="248" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#333">8 apples and</text>
  <text x="60" y="260" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#333">buys 5 more...</text>

  <!-- Main flow arrow from input -->
  <path d="M 100 230 H 150" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>

  <!-- Steered Reasoning Model -->
  <rect x="150" y="190" width="140" height="80" rx="5" fill="#e8ffe8" stroke="#00cc00" stroke-width="2" filter="url(#shadow)"/>
  <text x="220" y="212" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#00cc00">Steered</text>
  <text x="220" y="228" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#00cc00">Reasoning Model</text>
  <text x="220" y="245" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#666">deepseek-ai/</text>
  <text x="220" y="255" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#666">DeepSeek-R1-Distill-</text>
  <text x="220" y="265" font-family="Arial, sans-serif" font-size="8" text-anchor="middle" fill="#666">Qwen-1.5B</text>

  <!-- Addition circle -->
  <circle cx="220" cy="160" r="20" fill="white" stroke="#cc0000" stroke-width="2"/>
  <line x1="200" y1="160" x2="240" y2="160" stroke="#cc0000" stroke-width="2"/>
  <line x1="220" y1="140" x2="220" y2="180" stroke="#cc0000" stroke-width="2"/>
  <text x="205" y="155" font-family="Arial, sans-serif" font-size="16" fill="#cc0000">+</text>
  <text x="225" y="175" font-family="Arial, sans-serif" font-size="16" fill="#cc0000">+</text>
  <text x="250" y="165" font-family="Arial, sans-serif" font-size="10" fill="#666">hidden states</text>

  <!-- Arrow from model to token generation -->
  <path d="M 290 230 H 520 V 210 H 750" stroke="#333" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="520" y="205" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#666">logits → sampling</text>

  <!-- Token Generation Output -->
  <rect x="750" y="130" width="170" height="160" rx="5" fill="#f9f9f9" stroke="#666" stroke-width="2"/>
  <text x="835" y="148" font-family="Arial, sans-serif" font-size="12" font-weight="bold" text-anchor="middle" fill="#333">Generated Solution:</text>
  <!-- Redundant text in red -->
  <text x="755" y="165" font-family="Arial, sans-serif" font-size="8" fill="#d32f2f" font-style="italic">Let me think about this...</text>
  <text x="755" y="176" font-family="Arial, sans-serif" font-size="8" fill="#d32f2f" font-style="italic">Actually, let me reevaluate</text>
  <text x="755" y="187" font-family="Arial, sans-serif" font-size="8" fill="#d32f2f" font-style="italic">to make sure I'm correct...</text>
  <!-- Useful reasoning in green -->
  <text x="755" y="201" font-family="Arial, sans-serif" font-size="8" fill="#2e7d32" font-weight="bold">Sara starts with 8 apples</text>
  <!-- More redundant -->
  <text x="755" y="212" font-family="Arial, sans-serif" font-size="8" fill="#d32f2f" font-style="italic">Hmm, wait, let me double-check</text>
  <text x="755" y="223" font-family="Arial, sans-serif" font-size="8" fill="#d32f2f" font-style="italic">this calculation...</text>
  <!-- Useful -->
  <text x="755" y="237" font-family="Arial, sans-serif" font-size="8" fill="#2e7d32" font-weight="bold">She buys 5 more apples</text>
  <text x="755" y="248" font-family="Arial, sans-serif" font-size="8" fill="#2e7d32" font-weight="bold">So: 8 + 5 = 13</text>
  <!-- More redundant -->
  <text x="755" y="259" font-family="Arial, sans-serif" font-size="8" fill="#d32f2f" font-style="italic">Actually, let me verify once more</text>
  <!-- Final useful -->
  <text x="755" y="273" font-family="Arial, sans-serif" font-size="8" fill="#2e7d32" font-weight="bold">Total: 13 apples</text>
  <text x="755" y="284" font-family="Arial, sans-serif" font-size="8" fill="#333">\boxed{13}</text>

  <!-- Hidden states extraction path -->
  <path d="M 220 270 V 320" stroke="#ff6600" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="235" y="295" font-family="Arial, sans-serif" font-size="10" fill="#ff6600">layer 20</text>
  <text x="235" y="307" font-family="Arial, sans-serif" font-size="10" fill="#ff6600">hidden states</text>

  <!-- Chunk Classifier -->
  <rect x="160" y="320" width="120" height="70" rx="5" fill="#fff3e0" stroke="#ff6600" stroke-width="2" filter="url(#shadow)"/>
  <text x="220" y="342" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#ff6600">Chunk</text>
  <text x="220" y="358" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#ff6600">Classifier</text>
  <text x="220" y="374" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#666">useful/redundant</text>
  <text x="220" y="385" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#666">every 16 tokens</text>

  <!-- Classifier to PID -->
  <path d="M 280 355 H 340" stroke="#0066cc" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="310" y="350" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#0066cc">p_redundant</text>

  <!-- PID Controller -->
  <rect x="340" y="320" width="120" height="70" rx="5" fill="#e8f4fd" stroke="#0066cc" stroke-width="2" filter="url(#shadow)"/>
  <text x="400" y="342" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#0066cc">PID</text>
  <text x="400" y="358" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#0066cc">Controller</text>
  <text x="400" y="374" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#666">target: p*=0.5</text>
  <text x="400" y="385" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#666">Kp, Ki, Kd</text>

  <!-- PID to Control Vector -->
  <path d="M 460 355 H 520" stroke="#cc0000" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="490" y="350" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#cc0000">α</text>

  <!-- Control Vector -->
  <rect x="520" y="320" width="140" height="70" rx="5" fill="#ffe8e8" stroke="#cc0000" stroke-width="2" filter="url(#shadow)"/>
  <text x="590" y="342" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#cc0000">Control Vector</text>
  <text x="590" y="358" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#666">(v_useful - v_redundant)</text>
  <text x="590" y="374" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#cc0000">α × CV</text>
  <text x="590" y="387" font-family="Arial, sans-serif" font-size="9" text-anchor="middle" fill="#666">scaled for next step</text>

  <!-- Feedback path to addition -->
  <path d="M 590 320 V 110 H 220 V 140" stroke="#cc0000" stroke-width="2" fill="none" marker-end="url(#arrowhead)"/>
  <text x="405" y="105" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#cc0000">α × (v_useful - v_redundant)</text>
  <text x="405" y="118" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#cc0000">added to hidden states</text>

  <!-- Key insight moved to top -->
  <rect x="200" y="60" width="600" height="20" rx="10" fill="#fff9c4" stroke="#f9a825" stroke-width="1.5"/>
  <text x="500" y="74" font-family="Arial, sans-serif" font-size="11" text-anchor="middle" fill="#333" font-style="italic">
    "Dynamically steer reasoning traces towards usefulness while reducing redundancy"
  </text>

  <!-- Training phase annotation -->
  <rect x="40" y="430" width="420" height="100" rx="5" fill="#f5f5f5" stroke="#888" stroke-width="1" stroke-dasharray="5,5"/>
  <text x="50" y="450" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#333">Training Phase (offline):</text>
  <text x="50" y="470" font-family="Arial, sans-serif" font-size="12" fill="#666">1. Generate 1000 reasoning traces on GSM8K</text>
  <text x="50" y="488" font-family="Arial, sans-serif" font-size="12" fill="#666">2. Label thoughts as useful/redundant</text>
  <text x="50" y="506" font-family="Arial, sans-serif" font-size="12" fill="#666">3. Train chunk classifier (SGD @ layer 20)</text>
  <text x="50" y="524" font-family="Arial, sans-serif" font-size="12" fill="#666">4. Create control vector from thought means</text>

  <!-- Steering window -->
  <rect x="480" y="430" width="220" height="100" rx="5" fill="#e3f2fd" stroke="#2196f3" stroke-width="2"/>
  <text x="490" y="450" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#1565c0">Steering Window:</text>
  <text x="490" y="470" font-family="Arial, sans-serif" font-size="12" fill="#1565c0">• Initial free: 80 tokens</text>
  <text x="490" y="488" font-family="Arial, sans-serif" font-size="12" fill="#1565c0">• Active steering: 60 tokens</text>
  <text x="490" y="506" font-family="Arial, sans-serif" font-size="12" fill="#1565c0">• Target p_redundant: 0.5</text>
  <text x="490" y="524" font-family="Arial, sans-serif" font-size="12" fill="#1565c0">• Margin: 0.2</text>

  <!-- Results -->
  <rect x="720" y="430" width="240" height="100" rx="5" fill="#d4edda" stroke="#28a745" stroke-width="2"/>
  <text x="840" y="450" font-family="Arial, sans-serif" font-size="14" font-weight="bold" text-anchor="middle" fill="#155724">GSM8K Results:</text>
  <text x="840" y="475" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#155724">30% Token Reduction</text>
  <text x="840" y="500" font-family="Arial, sans-serif" font-size="16" font-weight="bold" text-anchor="middle" fill="#155724">+6% Accuracy</text>
  <text x="840" y="518" font-family="Arial, sans-serif" font-size="10" text-anchor="middle" fill="#155724">vs baseline DeepSeek-R1-Distill-1.5B</text>

  <!-- Color legend -->
  <rect x="755" y="300" width="150" height="45" rx="3" fill="#f5f5f5" stroke="#999" stroke-width="1"/>
  <text x="830" y="315" font-family="Arial, sans-serif" font-size="10" font-weight="bold" text-anchor="middle" fill="#333">Color Key:</text>
  <circle cx="765" cy="327" r="3" fill="#2e7d32"/>
  <text x="775" y="331" font-family="Arial, sans-serif" font-size="9" fill="#333">Useful thoughts</text>
  <circle cx="765" cy="337" r="3" fill="#d32f2f"/>
  <text x="775" y="341" font-family="Arial, sans-serif" font-size="9" fill="#333">Redundant filler</text>
</svg>
